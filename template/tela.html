<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Tela de Saída Completa</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <!-- Logo no topo -->
  <div class="logo">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
  </div>

  <div class="tela-container">
    <h1>Registros de Saída</h1>
    <ul class="lista-chamada" id="lista-chamada"></ul>
  </div>

  <script>
    // Atualiza automaticamente via SSE a cada novo item
    function atualizarTela() {
      fetch("{{ url_for('api_saidas') }}")
        .then(res => res.json())
        .then(data => {
          const groups = {};
          data.forEach(item => {
            const key = `${item.nome}||${item.observacao}||${item.responsavel}`;
            if (!groups[key]) groups[key] = { main: item, items: [] };
            groups[key].items.push(item);
          });
          const groupsArr = Object.values(groups);
          let html = '';
          groupsArr.forEach((group, idx) => {
            const cls = idx === 0 ? 'topo' : '';
            html += `<li class="${cls}">
                      <div class="item-container">
                        <div class="item-main">
                          <p><strong>Nome:</strong> ${group.main.nome}</p>
                          <p><strong>Local para Utilização:</strong> ${group.main.observacao}</p>
                          <p><strong>Autorizado Por:</strong> ${group.main.responsavel}</p>
                          <p><strong>Timestamp:</strong> ${group.main.timestamp}</p>
                        </div>
                        <div class="item-details">`;
            group.items.forEach(it => {
              html += `<span><strong>${it.tipo}</strong> – ${it.descricao} – ${it.quantidade} ${it.unidade}</span>`;
            });
            html += `   </div>
                      </div>
                    </li>`;
          });
          document.getElementById('lista-chamada').innerHTML = html;
        });
    }

    // Inicia SSE
    atualizarTela();
    const source = new EventSource("{{ url_for('stream') }}");
    source.onmessage = atualizarTela;
  </script>

</body>
</html>